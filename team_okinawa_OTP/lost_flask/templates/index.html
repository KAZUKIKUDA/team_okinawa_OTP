{% extends "base.html" %}

{% block title %}トップページ - 忘れ物掲示板{% endblock %}

{% block content %}
<main>
    {% if current_user.is_authenticated %}
        {% if current_user.confirmed %}
        <section class="post-form">
            <h2>投稿する</h2>
            <form action="{{ url_for('post') }}" method="post" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="item_name">忘れ物 <span class="required">*</span></label>
                    <input type="text" id="item_name" name="item_name" placeholder="例: 青い水筒" required>
                </div>

                <div class="form-group">
                    <label for="lost_area">エリア <span class="required">*</span></label>
                    <select id="lost_area" name="lost_area" required>
                        <option value="">選択してください</option>
                        <option value="A棟">A棟</option>
                        <option value="B棟">B棟</option>
                        <option value="C棟">C棟</option>
                        <option value="D棟">D棟</option>
                        <option value="E棟">E棟</option>
                        <option value="F棟">F棟</option>
                        <option value="G棟">G棟</option>
                        <option value="H棟">H棟</option>
                        <option value="体育館">体育館</option>
                        <option value="グラウンド">グラウンド</option>
                        <option value="その他">その他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="lost_place">詳細な場所 <span class="required">*</span></label>
                    <input type="text" id="lost_place" name="lost_place" placeholder="例: A101教室の机の中" required>
                </div>

                <div class="form-group">
                    <label for="description">概要（任意）</label>
                    <textarea id="description" name="description" placeholder="例: 〇〇のシールの貼ってある水筒です。"></textarea>
                </div>

                <div class="form-group">
                    <label for="image">写真</label>
                    <input type="file" id="image" name="image" accept="image/*">
                </div>
                <button type="submit">書き込む</button>
            </form>
        </section>
        {% else %}
        <div class="login-prompt">
            <p>投稿やコメントをするには、メールアドレスの確認が必要です。</p>
            <p>登録時に送信されたメールをご確認ください。</p>
        </div>
        {% endif %}
    {% else %}
    <div class="login-prompt">
        <p>投稿やコメントをするには、<a href="{{ url_for('login') }}">ログイン</a>が必要です。</p>
        <p>アカウントをお持ちでない場合は<a href="{{ url_for('register') }}">ユーザー登録</a>をしてください。</p>
    </div>
    {% endif %}

    <section class="posts-container">
        <h2>投稿一覧</h2>
        {% for post in posts %}
        <article class="post-card">
            <div class="post-header">
                <span class="username">{{ post.author.username }}</span>
                <span class="timestamp">{{ post.timestamp.strftime("%Y/%m/%d %H:%M") }}</span>
            </div>
            <div class="post-body">
                <div class="post-item-info">
                    <p><strong>忘れ物:</strong> {{ post.item_name }}</p>
                    <p><strong>場所:</strong> {{ post.lost_area }} - {{ post.lost_place }}</p>
                    {% if post.description %}
                    <div class="description-box">
                        <p><strong>概要:</strong></p>
                        <p>{{ post.description }}</p>
                    </div>
                    {% endif %}
                </div>

                {% if post.image_filename %}
                <img src="{{ url_for('static', filename='uploads/' + post.image_filename) }}" alt="投稿画像" class="post-image">
                {% endif %}
            </div>
            
            <div class="comments-section">
                <h3>コメント</h3>
                {% for comment in post.comments %}
                <div class="comment-card">
                    <span class="comment-username">{{ comment.author.username }}</span>
                    <span class="comment-timestamp">{{ comment.timestamp.strftime("%Y/%m/%d %H:%M") }}</span>
                    <p>{{ comment.content }}</p>
                </div>
                {% else %}
                <p class="no-comments">まだコメントがありません。</p>
                {% endfor %}
            </div>
            
            {% if current_user.is_authenticated and current_user.confirmed %}
            <div class="comment-form">
                <form action="{{ url_for('post_comment', post_id=post.id) }}" method="post">
                    <textarea name="content" placeholder="コメント" required></textarea>
                    <button type="submit">コメントする</button>
                </form>
            </div>
            {% endif %}
        </article>
        {% else %}
        <p>まだ投稿がありません。</p>
        {% endfor %}
    </section>
</main>
{% endblock %}

